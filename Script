-- Recorder Android Stable
-- Tested logic for Delta Android

if game.CoreGui:FindFirstChild("RecorderUI") then
	game.CoreGui.RecorderUI:Destroy()
end

local Players = game:GetService("Players")
local RunService = game:GetService("RunService")
local player = Players.LocalPlayer

local startTick = 0
local recording = false
local records = {}

-- UI
local gui = Instance.new("ScreenGui")
gui.Name = "RecorderUI"
gui.ResetOnSpawn = false
gui.Parent = game.CoreGui

local frame = Instance.new("Frame", gui)
frame.Size = UDim2.fromOffset(360, 180)
frame.Position = UDim2.fromOffset(40, 40)
frame.BackgroundColor3 = Color3.fromRGB(45,45,45)

local title = Instance.new("TextLabel", frame)
title.Size = UDim2.fromScale(1,0)
title.Size = UDim2.new(1,0,0,40)
title.Text = "Recorder"
title.TextColor3 = Color3.new(1,1,1)
title.BackgroundTransparency = 1
title.TextScaled = true

local function makeBtn(text, x)
	local b = Instance.new("TextButton", frame)
	b.Size = UDim2.fromOffset(100,40)
	b.Position = UDim2.fromOffset(x,60)
	b.Text = text
	b.BackgroundColor3 = Color3.fromRGB(70,70,70)
	b.TextColor3 = Color3.new(1,1,1)
	return b
end

local btnRecord = makeBtn("Record",20)
local btnStop = makeBtn("Stop",130)
local btnCopy = makeBtn("Copy",240)

-- Recorder API
local Recorder = {}

function Recorder:Fire(remote, ...)
	if not recording then
		remote:FireServer(...)
		return
	end

	local t = tick() - startTick
	table.insert(records,{
		time = t,
		remote = remote,
		args = {...}
	})
	remote:FireServer(...)
end

-- Buttons
btnRecord.MouseButton1Click:Connect(function()
	records = {}
	startTick = tick()
	recording = true
end)

btnStop.MouseButton1Click:Connect(function()
	recording = false
end)

btnCopy.MouseButton1Click:Connect(function()
	if recording then return end

	local out = {}
	table.insert(out,"-- Replay Script")
	table.insert(out,"local r = {}")
	table.insert(out,"local RS = game:GetService('RunService')")
	table.insert(out,"local start = tick()")

	for i,v in ipairs(records) do
		table.insert(out,
			string.format(
				"task.delay(%.3f,function() r[%d]:FireServer(%s) end)",
				v.time,
				i,
				table.concat((function()
					local t={}
					for _,a in ipairs(v.args) do
						table.insert(t,typeof(a)=="string" and string.format("%q",a) or tostring(a))
					end
					return t
				end)(),",")
			)
		)
	end

	if setclipboard then
		setclipboard(table.concat(out,"\n"))
	end
end)

-- Expose
getgenv().Recorder = Recorder
